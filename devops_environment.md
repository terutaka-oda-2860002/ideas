# CIとCDにの環境ついて
## 用語

| 用語 | 定義 |
|:---|---|
| ビルド | ワークスペースから成果物を生成すること。一般的にはコンパイル等が行われる | 
| CI |  継続的インテグレーション  | 
| CD | 継続的デリバリ |
| テスト | 正常性を確認するためのスクリプト等で、tapまたはxunit形式で出力されるもの。自動テストとも記述する |
| ステージング | ここでは、テストでとらえられない性質の不具合を人によるUIを通じて確認するための環境。ステージングで行う確認作業は手動テストとも記述する |

### 


こういうやり方だとハッピーになります。という図を書く。その図をベースポイントにしてほかの文書から
どこを説明しているのかがわかるようなものとして機能する。

~~~ mermad
TDgraph:
a -> b

~~~

## CIのトリガ
コミット時

## 自動デプロイのトリガとデプロイ先
mainへのプルリクエスト時、自動で行う
プルリクエスト時に、stageで

そして、



## CIのプロセス
### コミット
リポジトリへのGitHubへのコミット(典型的にはローカルでコミットしたものをGitHubへプッシュすることを指す)を意味する。事前にワークスペースでのテストが行われていることを想定しているが、必須とは限らない。
コミットにより、GitHub ActionやCircle CIなどが起動され、CIプロセスが実行される。
### ビルド
CIプロセスの最初の工程で、CIフレームワークによりビルド環境が作成され、ビルドが行われる。典型的には、make test などが実行されるイメージ(make testでは通常、make allした後 テストが実行されるように
Makefileを構成する)
### テスト
ビルドプロセスの最終工程で、テストが行われる。テスト自体は自動で行われ、結果がtapまたはxunit形式で出力される。
### デプロイ
CIのフレームワークはテストがOKだった場合、デプロイする。
する。
#### 自動デプロイの場合
ここまでの結果をmainへのプルリクエストとしてチケット作成する。
#### 手動デプロイの場合
ここまでの結果をstageへのプルリクエストとしてチケットを作成する。


## CDのプロセス
mainへのプルリクエストのいくつかのメタ情報をもとに、デリバリ方針が決まる。

### 自動デプロイの場合
自動デプロイを適用する場合は、プルリクエストは自動マージされる。
自動マージされた結果として、デプロイされる。

### 承認付デプロイの場合


##

## CI/CDの実際

テストを書くことが必須。
UIのテストについても、結果をtapなどで出力する必要があるため、ウェブアプリなどでは、開発フレームワークに応じたテストを利用するなどヘッドレスでテストすることが求められる。
自動テストを定義できないものでCIをしたい、場合はビルドのみとなる。


## ステージング(stagingあるいはproduction like)環境とその意義
CIでとらえられない性質の不具合の有無を人によるUIを通じて確認するためのもの（手動テストとも記述する）として定義する。
ロボットなどでテストするのはステージングとしては扱わないことにする。
CI/CDの観点では、ステージングへ分岐するということは、パイプラインが分断されることを意味する。（ステップ駆動となる）

例えば、規約として以下のようになっていたとする
1. マイクロバージョンアップの場合、自動テストグリーンを要求する
2. マイナーバージョンアップの場合、ステージングでのビルドグリーンを要求する
3. メジャーバージョンアップの場合、ステージングを経由して、手動テストを要求する。

1.のケースだと、コミットされたら自動テストが動き、グリーンなら、そのまま本番にデプロイされる。
2.のケースだと、自動テストグリーン後、本番ではなく、ステージングでのビルドを行う。ステージングのビルドがグリーンなら、そのまま本番にデプロイされる。
3.のケースだと、自動テストグリーン後、ステージングでビルドする。人が手動テストをステージングで行ったのち、
  テスト結果を、releaseファイルなどとして、コミットすることで、あらたなコミットを作成し、
  そのコミットに対してデプロイボタンを押すイメージ。

